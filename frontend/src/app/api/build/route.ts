import { NextRequest } from 'next/server';

export async function POST(request: NextRequest) {
  const { spec } = await request.json();

  const encoder = new TextEncoder();
  const stream = new ReadableStream({
    async start(controller) {
      const send = (event: any) => {
        controller.enqueue(
          encoder.encode(`data: ${JSON.stringify(event)}\n\n`)
        );
      };

      const delay = (ms: number) =>
        new Promise((resolve) => setTimeout(resolve, ms));

      try {
        // Status update
        send({ type: 'status', data: { message: 'Initializing SolForge compiler...' } });
        await delay(500);

        // Progress 1
        send({ type: 'progress', data: { step: 1, percent: 14 } });
        send({ type: 'thinking', data: { message: 'ðŸ¤” Analyzing specification...' } });
        send({ type: 'terminal', data: { message: '> Parsing natural language spec', level: 'info' } });
        await delay(1000);

        send({ type: 'thinking', data: { message: 'ðŸ“‹ Breaking down requirements into components' } });
        send({ type: 'thinking', data: { message: '- State management structure' } });
        send({ type: 'thinking', data: { message: '- Instruction handlers needed' } });
        send({ type: 'thinking', data: { message: '- Access control requirements' } });
        await delay(1500);

        // Progress 2
        send({ type: 'progress', data: { step: 2, percent: 28 } });
        send({ type: 'thinking', data: { message: 'ðŸ—ï¸ Designing program architecture' } });
        send({ type: 'terminal', data: { message: '> Generating Anchor program structure', level: 'info' } });
        await delay(1000);

        send({ type: 'code', data: {
          file: 'lib.rs',
          content: `use anchor_lang::prelude::*;

declare_id!("PLACEHOLDER_PROGRAM_ID");

#[program]
pub mod solforge_program {
    use super::*;
    
    pub fn initialize(ctx: Context<Initialize>) -> Result<()> {
        // Implementation generated by SolForge
        Ok(())
    }
}`
        }});
        await delay(1500);

        // Progress 3
        send({ type: 'progress', data: { step: 3, percent: 42 } });
        send({ type: 'thinking', data: { message: 'âœï¸ Writing instruction handlers' } });
        send({ type: 'terminal', data: { message: '> Writing state.rs', level: 'info' } });
        send({ type: 'terminal', data: { message: '> Writing instructions.rs', level: 'info' } });
        await delay(1000);

        send({ type: 'code', data: {
          file: 'state.rs',
          content: `use anchor_lang::prelude::*;

#[account]
pub struct ProgramState {
    pub authority: Pubkey,
    pub initialized: bool,
    pub bump: u8,
}`
        }});
        await delay(1500);

        // Progress 4
        send({ type: 'progress', data: { step: 4, percent: 56 } });
        send({ type: 'thinking', data: { message: 'ðŸ”§ Compiling Solana program' } });
        send({ type: 'terminal', data: { message: '> Running cargo build-sbf', level: 'info' } });
        await delay(1000);
        send({ type: 'terminal', data: { message: '> Compiling dependencies...', level: 'info' } });
        await delay(1500);
        send({ type: 'terminal', data: { message: 'âœ“ Compilation successful', level: 'success' } });

        // Progress 5
        send({ type: 'progress', data: { step: 5, percent: 70 } });
        send({ type: 'thinking', data: { message: 'ðŸ“¦ Preparing deployment' } });
        send({ type: 'terminal', data: { message: '> Connecting to Solana devnet', level: 'info' } });
        await delay(1000);

        // Generate mock program ID and signature
        const mockProgramId = Array.from({ length: 44 }, () => 
          'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz123456789'[
            Math.floor(Math.random() * 58)
          ]
        ).join('');

        const mockSignature = Array.from({ length: 88 }, () => 
          'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz123456789'[
            Math.floor(Math.random() * 58)
          ]
        ).join('');

        send({ type: 'chain_log', data: {
          action: 'Program deployment initiated',
          signature: mockSignature,
        }});
        await delay(1500);

        // Progress 6
        send({ type: 'progress', data: { step: 6, percent: 84 } });
        send({ type: 'thinking', data: { message: 'ðŸš€ Deploying to Solana' } });
        send({ type: 'terminal', data: { message: '> Deploying program...', level: 'info' } });
        await delay(2000);
        send({ type: 'terminal', data: { message: `âœ“ Program deployed: ${mockProgramId}`, level: 'success' } });

        send({ type: 'chain_log', data: {
          action: 'Program deployment confirmed',
          signature: mockSignature,
        }});

        // Progress 7
        send({ type: 'progress', data: { step: 7, percent: 100 } });
        send({ type: 'thinking', data: { message: 'âœ… Build verification complete' } });
        send({ type: 'terminal', data: { message: '> Generating TypeScript SDK', level: 'info' } });
        await delay(1000);
        send({ type: 'terminal', data: { message: 'âœ“ SDK generated successfully', level: 'success' } });

        // Complete
        await delay(500);
        send({ type: 'complete', data: {
          programId: mockProgramId,
          signature: mockSignature,
          duration: 47.2,
        }});

        controller.close();
      } catch (error) {
        send({ type: 'error', data: { message: 'Build failed' } });
        controller.close();
      }
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
